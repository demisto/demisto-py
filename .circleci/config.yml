### =============================================================
### This configuration file is used by CircleCI build server
### https://circleci.com/docs/config-sample
### =============================================================
version: 2.1

references:
  install_poetry: &install_poetry
      - run:
          name: Install Poetry
          command: |
            # in old images we need to remove existing poetry
            rm -rf $HOME/.poetry/bin/poetry
            sudo curl -sSL https://install.python-poetry.org | python3 -
            poetry --version

  install_project_dependencies: &install_project_dependencies    
      - run:
          name: Install Project Dependencies
          command: |
            poetry install --no-interaction --no-ansi --no-root

  poetry_build: &poetry_build
      - run:
          name: Build Package
          command: |
            poetry build
jobs:
  run-unit-tests:
    parameters:
      pythonversion:
        type: string
    docker:
      - image: cimg/python:<< parameters.pythonversion >>-node
    steps:
      - checkout
      - <<: *install_poetry
      - <<: *install_project_dependencies
      - run:
          name: Run Unit Tests
          command: |
            poetry run python -m pytest -v tests
  verify:
    docker:
        - image: ubuntu-2004:202201-02
    steps:
      - checkout
        # needed because we are using docker command inside verify.sh file 
      - run:
          name: Install Java and Swagger Codegen CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-8-jdk
            sudo wget https://repo1.maven.org/maven2/io/swagger/codegen/v3/swagger-codegen-cli/3.0.27/swagger-codegen-cli-3.0.27.jar -O /usr/local/bin/swagger-codegen-cli.jar
            echo '#!/bin/bash' > swagger-codegen
            echo 'java -jar /usr/local/bin/swagger-codegen-cli.jar "$@"' >> swagger-codegen
            chmod +x swagger-codegen
            sudo mv swagger-codegen /usr/local/bin/
      - run:
          name: Verify
          command: |
            ./verify.sh
  
  publish-to-test-pypi:
    docker:
      - image: cimg/python:3.10-node
    steps:
      - checkout
      - <<: *poetry_build
      - run:
          name: Publish Package Test PyPI
          command: |
              poetry config repositories.testpypi https://test.pypi.org/legacy/
              poetry publish -u __token__ -p ${PYPI_TEST_TOKEN} -r testpypi
    

  publish-to-pypi:
    docker:
      - image: cimg/python:3.10-node
    steps:
      - checkout
      - <<: *poetry_build
      - run:
          name: Publish Package PyPI
          command: |
            poetry version

workflows:
  build_and_release:
    jobs:
      - run-unit-tests:
          matrix:
            parameters:
              pythonversion: ["3.8", "3.9", "3.10"]   
          name: run-unit-tests-<< matrix.pythonversion >>
      - verify
      - publish-to-test-pypi:
          requires:
            - run-unit-tests
            - verify
          filters:
            branches:
              only: master
      - publish-to-pypi:
          requires:
            - run-unit-tests
            - verify
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+$/ # only run on tags [e.g. v0.0.0]
            branches:
              ignore: /.*/
          